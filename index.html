<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chart Dashboard</title>

<!-- Lightweight Charts CDN -->
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<style>
:root{
  --bg:#071122; --panel:#0b2230; --muted:#94a3b8; --accent:#38bdf8;
  --up:#22c55e; --down:#ef4444; --surface:#0f1724;
  --card:#0f2a37;
}
*{box-sizing:border-box;font-family:Inter, Arial, sans-serif}
html,body{height:100%;margin:0;background:var(--bg);color:#e6eef8}
.app{display:flex;height:100vh;overflow:hidden}

/* Left watchlist */
.side{
  width:300px;
  background:#071a27;
  padding:18px;
  border-right:1px solid rgba(255,255,255,0.05);
  overflow:auto;
}
.side h2{margin:0 0 12px;color:var(--accent);font-size:28px}
.search{width:100%;background:#071826;color:#cfe6ff;padding:10px;margin-bottom:12px;border-radius:8px;border:none}
.watchlist{list-style:none;padding:0;margin:0}
.watchlist li{
  background:#122b36;margin:8px 0;padding:12px;border-radius:8px;cursor:pointer;
  text-transform:uppercase;letter-spacing:0.6px;color:#e6eef8;font-weight:600
}
.watchlist li.active{background:#244f63}
.add-row{display:flex;gap:8px;margin-top:12px}
.add-row input{flex:1;background:#071026;padding:10px;color:#cfe6ff;border-radius:8px;border:none}
.add-row button{background:var(--accent);color:#042330;padding:10px 14px;border-radius:8px;border:none;cursor:pointer}

/* Ribbon indicator bar */
.ribbon{
  width:100%;
  padding:10px 16px;
  background:#0d2030;
  display:flex;
  gap:16px;
  border-bottom:1px solid rgba(255,255,255,0.05);
}
.ribbon-item{
  color:var(--muted);
  font-size:13px;
  display:flex;
  flex-direction:column;
}
.ribbon-item label{font-size:12px;margin-bottom:2px;color:#7ea0c4}
.ribbon-item input,.ribbon-item select{
  background:#071827;
  border:none;
  padding:6px;
  color:#cfe6ff;
  border-radius:6px;
}
/* Main chart area */
.main{flex:1;display:flex;flex-direction:column;min-width:0}
.toolbar{
  height:60px;
  background:#0c1824;
  display:flex;
  align-items:center;
  padding:0 18px;
  border-bottom:1px solid rgba(255,255,255,0.05);
  gap:16px;
}
.title{font-weight:700;font-size:20px}

.tf-group{display:flex;gap:6px;margin-left:10px}
.tf-btn{
  background:#071826;
  border-radius:6px;
  padding:6px 10px;
  border:none;
  color:#cfe6ff;
  cursor:pointer;
  font-size:13px
}
.tf-btn.active{background:var(--accent);color:#01222b}

.toggles{margin-left:auto;display:flex;gap:14px;align-items:center}
.toggle{display:flex;align-items:center;gap:6px;font-size:14px;color:var(--muted)}

.chart-wrap{flex:1;display:flex;position:relative}
.chart-box{flex:1;background:var(--surface);padding:0;display:flex;flex-direction:column}
#chart{flex:1;min-height:0;border-radius:0}

.spinner,.error{
  position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
  padding:12px 18px;border-radius:10px;font-weight:700
}
.spinner{background:rgba(0,0,0,0.6)}
.error{background:#2b0f0f;color:#ffd2d2;display:none}
.hidden{display:none}

/* responsive */
@media(max-width:900px){
  .side{display:none}
  .ribbon{display:none}
}
</style>
</head>

<body>
<div class="app">

  <!-- LEFT WATCHLIST -->
  <aside class="side">
    <h2>Watchlist</h2>
    <input id="searchInput" class="search" placeholder="Search symbol..." />

    <ul id="watchlist" class="watchlist"></ul>

    <div class="add-row">
      <input id="addSymbol" placeholder="Add symbol, e.g. RELIANCE.NS" />
      <button id="addBtn">Add</button>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <!-- TIMEFRAMES + TOGGLES -->
    <div class="toolbar">
      <div class="title" id="symbolTitle">Loading...</div>

      <div class="tf-group" id="timeframes">
        <button class="tf-btn" data-tf="1m">1m</button>
        <button class="tf-btn" data-tf="5m">5m</button>
        <button class="tf-btn" data-tf="15m">15m</button>
        <button class="tf-btn" data-tf="30m">30m</button>
        <button class="tf-btn" data-tf="60m">60m</button>
        <button class="tf-btn active" data-tf="1D">1D</button>
        <button class="tf-btn" data-tf="1W">1W</button>
        <button class="tf-btn" data-tf="1M">1M</button>
      </div>

      <div class="toggles">
        <div class="toggle"><input type="checkbox" id="toggleReliable" checked /> Reliable</div>
        <div class="toggle"><input type="checkbox" id="toggleLux" checked /> Lux</div>
        <div class="toggle"><input type="checkbox" id="toggleIsland" checked /> Island</div>
      </div>
    </div>

    <!-- RIBBON (Indicators moved here) -->
    <div class="ribbon">
      <div class="ribbon-item">
        <label>Pivot L</label>
        <input id="pivotLeft" type="number" value="15" />
      </div>
      <div class="ribbon-item">
        <label>Pivot R</label>
        <input id="pivotRight" type="number" value="15" />
      </div>

      <div class="ribbon-item">
        <label>Lux Len</label>
        <input id="luxLen1" type="number" value="50" />
      </div>
      <div class="ribbon-item">
        <label>Lux Mult</label>
        <input id="luxMlt1" type="number" step="0.1" value="2" />
      </div>

      <div class="ribbon-item">
        <label>Island Trend</label>
        <input id="islandTrend" type="number" value="10" />
      </div>
      <div class="ribbon-item">
        <label>Island Vol</label>
        <select id="islandVolFilter">
          <option value="true" selected>On</option>
          <option value="false">Off</option>
        </select>
      </div>

      <div class="ribbon-item">
        <label>Volume</label>
        <select id="showVolume">
          <option value="true" selected>Show</option>
          <option value="false">Hide</option>
        </select>
      </div>

      <div class="ribbon-item">
        <label>Poll (sec)</label>
        <input id="pollInterval" type="number" value="5" />
      </div>

      <button id="applyIndicators" style="margin-left:auto;background:var(--accent);color:#01222b;border:none;border-radius:6px;padding:8px 14px;cursor:pointer">Apply</button>
    </div>

    <div class="chart-wrap">
      <div class="chart-box">
        <div id="chart"></div>
        <div id="spinner" class="spinner hidden">Loading...</div>
        <div id="error" class="error"></div>
      </div>
    </div>

  </main>
<script>

/* ---------------- CONFIG ---------------- */
const WORKER_URL = "https://black-tree-2e32.sriviadithi.workers.dev/?symbol=";
const DEFAULT_SYMBOLS = ["RELIANCE.NS","TCS.NS","INFY.NS","HDFCBANK.NS"];

/* DOM */
const watchlistEl = document.getElementById('watchlist');
const symbolTitle = document.getElementById('symbolTitle');
const chartDiv = document.getElementById('chart');
const spinner = document.getElementById('spinner');
const errorBox = document.getElementById('error');

const addSymbolInput = document.getElementById('addSymbol');
const addBtn = document.getElementById('addBtn');
const searchInput = document.getElementById('searchInput');

const tfButtons = [...document.querySelectorAll('.tf-btn')];
const showVolume = document.getElementById('showVolume');

const toggleReliable = document.getElementById('toggleReliable');
const toggleLux = document.getElementById('toggleLux');
const toggleIsland = document.getElementById('toggleIsland');

const pivotLeft = document.getElementById('pivotLeft');
const pivotRight = document.getElementById('pivotRight');

const luxLen1 = document.getElementById('luxLen1');
const luxMlt1 = document.getElementById('luxMlt1');

const islandTrend = document.getElementById('islandTrend');
const islandVolFilter = document.getElementById('islandVolFilter');

const applyIndicatorsBtn = document.getElementById('applyIndicators');
const pollIntervalInput = document.getElementById('pollInterval');

let watchSymbols = JSON.parse(localStorage.getItem('watchSymbols')) || DEFAULT_SYMBOLS.slice();

let chart = null;
let candleSeries = null;
let volumeSeries = null;
let srLines = [];
let lastSymbol = null;
let activeTF = "1D";
let pollTimer = null;


/* ---------------- CHART CREATION ---------------- */
function createChart(){
  if(chart) return;

  chart = LightweightCharts.createChart(chartDiv, {
    layout:{ backgroundColor:"#0f1724", textColor:"#d1d4dc" },
    rightPriceScale:{ borderColor:"#485c7b" },
    timeScale:{ borderColor:"#485c7b", timeVisible:true },
    grid:{ vertLines:{color:"#253248"}, horzLines:{color:"#253248"} }
  });

  candleSeries = chart.addCandlestickSeries({
    upColor:"#22c55e", downColor:"#ef4444",
    wickVisible:true, borderVisible:true
  });

  volumeSeries = chart.addHistogramSeries({
    priceScaleId:'',
    scaleMargins:{ top:0.8, bottom:0 },
    priceFormat:{ type:"volume" }
  });
}

/* UI helpers */
function showSpinner(){ spinner.classList.remove('hidden'); }
function hideSpinner(){ spinner.classList.add('hidden'); }
function showError(msg){ errorBox.textContent=msg; errorBox.style.display='block'; }
function hideError(){ errorBox.style.display='none'; }

/* Render watchlist */
function renderWatchlist(){
  watchlistEl.innerHTML = '';
  watchSymbols.forEach(sym=>{
    const li=document.createElement('li');
    li.textContent=sym;
    li.dataset.symbol=sym;
    li.onclick=()=>loadChart(sym);
    watchlistEl.appendChild(li);
  });
}
renderWatchlist();

addBtn.onclick = ()=>{
  const v = addSymbolInput.value.trim().toUpperCase();
  if(v && !watchSymbols.includes(v)){
    watchSymbols.unshift(v);
    localStorage.setItem('watchSymbols',JSON.stringify(watchSymbols));
    renderWatchlist();
    loadChart(v);
  }
  addSymbolInput.value='';
};

searchInput.oninput = e=>{
  const q = e.target.value.trim().toLowerCase();
  [...watchlistEl.children].forEach(li=>{
    li.style.display = li.textContent.toLowerCase().includes(q) ? "" : "none";
  });
};

/* Timeframe buttons */
tfButtons.forEach(btn=>{
  btn.onclick = ()=>{
    tfButtons.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    activeTF = btn.dataset.tf;
    if(lastSymbol) loadChart(lastSymbol);
  };
});
/* Fetch OHLC */
async function fetchOHLC(symbol){
  const url = WORKER_URL + symbol;
  try{
    const res = await fetch(url,{cache:"no-store"});
    const json = await res.json();

    if(Array.isArray(json)) return json;

    if(json?.chart?.result?.[0]){
      const r = json.chart.result[0];
      const ts = r.timestamp;
      const q = r.indicators.quote[0];
      const out=[];
      for(let i=0;i<ts.length;i++){
        if(q.open[i]==null) continue;
        out.push({
          time:ts[i],
          open:q.open[i],
          high:q.high[i],
          low:q.low[i],
          close:q.close[i],
          volume:q.volume[i]||0
        });
      }
      return out;
    }

    return [];
  }catch(e){
    return [];
  }
}

/* Convert TF (simplified) */
function convertTF(bars, tf){
  return bars; // keep simple for now
}

/* Indicators */
function clearIndicators(){
  for(const l of srLines){
    try{ chart.removePriceLine(l); }catch(_){}
  }
  srLines=[];
}

function drawLevels(levels){
  for(const L of levels){
    const line = candleSeries.createPriceLine({
      price:L.price,
      color:L.color,
      title:L.label,
      lineWidth:2
    });
    srLines.push(line);
  }
}

function computeReliable(bars){
  const lev=[];
  for(let i=2;i<bars.length-2;i++){
    if(bars[i].high>bars[i-1].high && bars[i].high>bars[i+1].high){
      lev.push({price:bars[i].high,label:'PH',color:'#ef4444'});
    }
    if(bars[i].low<bars[i-1].low && bars[i].low<bars[i+1].low){
      lev.push({price:bars[i].low,label:'PL',color:'#22c55e'});
    }
  }
  return lev;
}

function computeLux(bars){
  if(bars.length<50) return [];
  const last = bars[bars.length-1];
  return [
    {price:last.high,label:"Lux High",color:"#60a5fa"},
    {price:last.low,label:"Lux Low",color:"#7c3aed"}
  ];
}

function computeIsland(){ return []; }

/* Load chart */
async function loadChart(symbol){
  lastSymbol = symbol;
  createChart();
  showSpinner();
  hideError();
  symbolTitle.textContent = symbol;

  let bars = await fetchOHLC(symbol);
  hideSpinner();

  if(!bars.length){
    showError("No data");
    return;
  }

  bars.sort((a,b)=>a.time-b.time);
  bars = convertTF(bars,activeTF);

  candleSeries.setData(bars);
  chart.timeScale().fitContent();

  if(showVolume.value==="true"){
    volumeSeries.setData(bars.map(b=>({
      time:b.time, value:b.volume, color:b.close>=b.open?'#22c55e':'#ef4444'
    })));
  }else{
    volumeSeries.setData([]);
  }

  clearIndicators();

  let levels=[];
  if(toggleReliable.checked) levels.push(...computeReliable(bars));
  if(toggleLux.checked)      levels.push(...computeLux(bars));

  drawLevels(levels);
}

applyIndicatorsBtn.onclick = ()=> lastSymbol && loadChart(lastSymbol);

/* default load */
loadChart(watchSymbols[0]);

</script>

</body>
</html>
